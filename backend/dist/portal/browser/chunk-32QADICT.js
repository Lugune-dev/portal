import{a as w}from"./chunk-KSUGELIG.js";import{a as q}from"./chunk-N5RQHMOU.js";import{$ as s,Ha as y,J as a,Ja as A,Q as c,R as h,Ua as I,W as f,Wa as C,_ as p,_a as S,aa as n,ia as _,ja as x,ka as l,kb as k,mb as E,ua as o,v,va as g,w as u,wa as d}from"./chunk-ZQSPQ25S.js";function V(i,t){i&1&&(s(0,"div"),o(1,"Loading..."),n())}function T(i,t){if(i&1&&(s(0,"div",4),o(1),n()),i&2){let e=l();a(),g(e.error)}}function R(i,t){if(i&1){let e=_();s(0,"div",8)(1,"button",9),x("click",function(){v(e);let m=l(2);return u(m.confirm("approved"))}),o(2,"Approve"),n(),s(3,"button",10),x("click",function(){v(e);let m=l(2);return u(m.confirm("rejected"))}),o(4,"Reject"),n()()}}function N(i,t){if(i&1&&(s(0,"div",11),o(1),n()),i&2){let e=l(2);a(),d("You must sign in as the approver (",e.request.approver_email,") to take action.")}}function F(i,t){if(i&1&&(s(0,"div",12),o(1),n()),i&2){let e=l(2);a(),d("This request has been ",e.status,".")}}function M(i,t){if(i&1&&(s(0,"div")(1,"p")(2,"strong"),o(3,"Field:"),n(),o(4),n(),s(5,"p")(6,"strong"),o(7,"Form:"),n(),o(8),n(),s(9,"p")(10,"strong"),o(11,"Requested at:"),n(),o(12),y(13,"date"),n(),s(14,"p")(15,"strong"),o(16,"Approver Email:"),n(),o(17),n(),f(18,R,5,0,"div",5)(19,N,2,1,"div",6)(20,F,2,1,"div",7),n()),i&2){let e=l();a(4),d(" ",e.request.field_name),a(4),d(" ",e.request.form_type_code||e.request.instance_id),a(4),d(" ",A(13,7,e.request.created_at,"short")),a(5),d(" ",e.request.approver_email),a(),p("ngIf",!e.isSigned&&e.isAllowed),a(),p("ngIf",!e.isAllowed),a(),p("ngIf",e.isSigned)}}var b=class i{constructor(t,e,r,m){this.route=t;this.approvals=e;this.auth=r;this.router=m}request=null;loading=!1;error="";token=null;isAllowed=!1;isSigned=!1;status="";ngOnInit(){this.route.queryParamMap.subscribe(t=>{if(this.token=t.get("token"),!this.token){this.error="Missing token";return}this.loadToken()})}loadToken(){this.loading=!0,this.approvals.verifyToken(this.token).subscribe(t=>{if(this.loading=!1,!t||!t.success){this.error=t&&t.error||"Invalid token or server error";return}this.request=t.request,this.status=this.request.status,this.isSigned=this.request.status!=="pending";let e=this.auth.getUserEmail();if(this.isAllowed=this.auth.isAuthenticated()&&e&&this.request.approver_email&&e.toLowerCase()===this.request.approver_email.toLowerCase(),!this.auth.isAuthenticated()){let r=this.router.url;this.router.navigate(["/login"],{queryParams:{returnUrl:r}})}},t=>{this.loading=!1,this.error="Server error verifying token"})}confirm(t){if(!this.token)return;let e=this.auth.getFullName()||this.auth.getUserEmail();this.approvals.requestApproval,fetch("https://portal-api-z927.onrender.com/api/approvals/confirm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.token,decision:t,approverName:e})}).then(r=>r.json()).then(r=>{r&&r.success?(this.isSigned=!0,this.status=r.status||t):this.error=r&&r.error?r.error:"Failed to confirm"}).catch(r=>{this.error="Network error confirming"})}static \u0275fac=function(e){return new(e||i)(c(k),c(w),c(q),c(E))};static \u0275cmp=h({type:i,selectors:[["app-approvals-verify"]],decls:6,vars:3,consts:[[1,"p-8","max-w-2xl","mx-auto"],[1,"text-2xl","font-bold","mb-4"],[4,"ngIf"],["class","text-red-600",4,"ngIf"],[1,"text-red-600"],["class","mt-4 flex gap-3",4,"ngIf"],["class","mt-4 text-yellow-700",4,"ngIf"],["class","mt-4 text-green-700",4,"ngIf"],[1,"mt-4","flex","gap-3"],[1,"px-4","py-2","bg-green-600","text-white","rounded",3,"click"],[1,"px-4","py-2","bg-red-600","text-white","rounded",3,"click"],[1,"mt-4","text-yellow-700"],[1,"mt-4","text-green-700"]],template:function(e,r){e&1&&(s(0,"div",0)(1,"h2",1),o(2,"Approval Request"),n(),f(3,V,2,0,"div",2)(4,T,2,1,"div",3)(5,M,21,10,"div",2),n()),e&2&&(a(3),p("ngIf",r.loading),a(),p("ngIf",r.error),a(),p("ngIf",r.request))},dependencies:[S,I,C],encapsulation:2})};export{b as ApprovalsVerifyComponent};
